{% load static %}

<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Room</title>

  <link rel="stylesheet" href="{% static '../static/assets/style.css' %}">
  <link rel="stylesheet" href="{% static '../static/assets/bootstrap-5.3.3-dist/css/bootstrap.min.css' %}">
  <link rel="stylesheet" href="{% static '../static/assets/bootstrap-5.3.3-dist/css/bootstrap-utilities.min.css' %}">
  <link rel="stylesheet" href="{% static '../static/assets/bootstrap-5.3.3-dist/css/bootstrap-grid.min.css' %}">
  <script src=" {% static '../static/assets/bootstrap-5.3.3-dist/js/bootstrap.bundle.min.js' %}"></script>

  <style>
    body,
    html {
      height: 100%;
    }

    .container-main {

      margin-top: 2px;
      width: 55%;
      max-width: 60%;
      min-height: 80%;

      display: flex;
      flex-direction: column;
    }

    .chat-container {
      margin-top: 10px;
      padding: 20px;
      border: 1px solid #ccc;
      border-radius: 8px;
      background-color: #fcfcfc;
      box-shadow: 0 0 2px rgba(0, 0, 0, 0.1);
    }

    #chat-box {
      height: 200px;
      overflow-y: auto;
    }

    .footer {
      position: fixed;
      bottom: 0;
      width: 100%;
      background-color: none;
      text-align: center;
      padding: 10px 0;
    }
  </style>

</head>

<body class="">

  <div class="navbar">

    <form action=" {% url 'home'%}">

      <button class="btnLogo">

        <img src="{% static '../static/assets/chat2.png' %}" alt="">
        <h1>ChatRoom</h1>

      </button>
      
    </form>

      <!--lISTA-->
      <div class="header-opciones">

        
            <ul><a  id="pageSelected" href="{% url 'home' %}">Home</a></ul>
            <ul><a href="{% url 'room' %}">Rooms</a></ul>


      </div>

    </div>

  <!-- Modal para ingresar el nombre de usuario -->
<div class="modal fade" id="usernameModal" tabindex="-1" aria-labelledby="usernameModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="usernameModalLabel">Enter your username</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <input type="text" id="usernameInput" class="form-control" placeholder="Enter your name">
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-primary" id="confirmUsernameButton">Join Chat</button>
      </div>
    </div>
  </div>
</div>


  <div class="container-fluid vh-100 d-flex justify-content-center align-items-center">

    <div class="container-main">

      <div class="card border-0 border-bottom" style="border-radius: 0; border-bottom: 2px solid #000;">
        <div class="card-body m-0">
          <button class="sbutton" style="width: 96px;" onclick="location.href='/'">Return</button>
          <button class="sbutton" style="width: 96px;" id="connectButton" onclick="">Connect</button>
          <button class="sbutton" style="width: 110px;" id="disconnectButton" onclick="">Disconnect</button>
        </div>
      </div>


      <div class="chat-container container-fluid">

        <h1 class="display-6 text-center">Guestroom</h1>

        <div id="chat-box">

        </div>
        <div class="input-group mt-3">
          <input type="text" class="form-control" placeholder="Type a message..." aria-label="Chat input" id="messageInput">
          <button class="btn btn-primary" id="sendButton" type="button">Send</button>
        </div>
      </div>

      <div class="card" style="margin-top: 20px;  margin-bottom: 100px;">
        <h5 class="card-header">Log</h5>
        <div id="chat-log" class="card-body" style="max-height: 128px; overflow-y: auto;">

        </div>
      </div>


    </div>


  </div>

  </div>

  <footer class="footer border-top">
    <a class="slink" href="/">© 2024 Jaime B. & Edwar G. </a>

  </footer>
  

  <script>

let chatSocket = null;
let username = null;

function writeMessage(str_sender, str_message) {
  const chatBox = document.getElementById('chat-box');
  const messageElement = document.createElement('p');
  messageElement.innerHTML = `<strong>${str_sender}: </strong> ${str_message}`;
  chatBox.appendChild(messageElement);
  chatBox.scrollTop = chatBox.scrollHeight;
}

function connectWebSocket() {
  if (!username) {
    console.log("Username not set!");
    return;
  }

  const chatLog = document.getElementById('chat-log');

  if (chatSocket && chatSocket.readyState === WebSocket.OPEN) {
    console.log("Already connected!");
    chatLog.innerHTML += `<p class="card-text"> Already connected! </p>`;
    chatLog.scrollTop = chatLog.scrollHeight;
    return;
  }

  chatSocket = new WebSocket('ws://' + window.location.host + '/ws/chatroom/guestroom/');

  chatSocket.onopen = function (e) {
    console.log("Connected to the WebSocket server");
    chatLog.innerHTML += `<p class="card-text"> Connected to the WebSocket server! </p>`;
    chatLog.scrollTop = chatLog.scrollHeight;
  };

  chatSocket.onmessage = function (e) {
    const data = JSON.parse(e.data);
    writeMessage(data.username, data.message);
  };

  chatSocket.onclose = function (e) {
    console.log("Disconnected from the WebSocket server");
    chatLog.innerHTML += `<p class="card-text"> Disconnected from the server.</p>`;
    chatLog.scrollTop = chatLog.scrollHeight;
  };

  chatSocket.onerror = function (e) {
    console.log("WebSocket error: ", e);
    chatLog.innerHTML += `<p class="card-text">WebSocket error: ${e}</p>`;
    chatLog.scrollTop = chatLog.scrollHeight;
  };
}

function disconnectWebSocket() {
  const chatLog = document.getElementById('chat-log');

  if (chatSocket && chatSocket.readyState === WebSocket.OPEN) {
    chatSocket.close();
    console.log("Disconnected manually from the WebSocket server");
    chatLog.innerHTML += `<p class="card-text">Disconnected from the server.</p>`;
    chatLog.scrollTop = chatLog.scrollHeight;
  } else {
    chatLog.innerHTML += `<p class="card-text">No active connection to disconnect.</p>`;
    chatLog.scrollTop = chatLog.scrollHeight;
  }
}

// Abrir el modal para solicitar el nombre
document.getElementById('connectButton').onclick = function () {
  const usernameModal = new bootstrap.Modal(document.getElementById('usernameModal'), {
    backdrop: 'static',
    keyboard: false
  });
  usernameModal.show();
};

// Confirmar el nombre y conectar al WebSocket
document.getElementById('confirmUsernameButton').onclick = function () {
  const input = document.getElementById('usernameInput').value.trim();
  
  if (input) {
    username = input;
    connectWebSocket();
    
    // Cerrar el modal una vez que el usuario haya ingresado su nombre
    const usernameModal = bootstrap.Modal.getInstance(document.getElementById('usernameModal'));
    usernameModal.hide();
  } else {
    alert('Please enter a valid username.');
  }
};

// Enviar mensaje cuando se presiona el botón "Send"
document.getElementById('sendButton').onclick = function () {
  const messageInput = document.getElementById('messageInput');
  const message = messageInput.value.trim();

  if (message && chatSocket && chatSocket.readyState === WebSocket.OPEN) {
    chatSocket.send(JSON.stringify({
      'username': username,
      'message': message
    }));

    messageInput.value = '';
  } else {
    console.log("No message sent!");
  }
};

document.getElementById('disconnectButton').onclick = disconnectWebSocket;
ment.getElementById('disconnectButton').onclick = disconnectWebSocket;

  </script>

</body>

</html>